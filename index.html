<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本政府によるウクライナ支援金</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f0f0;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 800px;
            width: 90%;
            margin: 2rem auto;
        } 

        h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        #amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #3498db;
            margin: 1rem 0;
        }

        #amountJapanese {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 2rem;
        }

        #slider {
            height: 100px;
            position: relative;
            overflow: hidden;
            margin-top: 1rem;
        }

        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.9rem;
            color: #34495e;
            transition: transform 0.5s ease, opacity 0.5s ease;
            opacity: 0;
            padding: 5px 10px;
            box-sizing: border-box;
            cursor: default;
        }

        .slide-date {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .slide-content {
            display: flex;
            align-items: baseline;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .slide-amount {
            font-weight: bold;
            color: #34495e; /* Same color as the description text */
            margin-right: 8px; /* Space after money figure */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .slide-emoji {
            margin-right: 8px; /* Space after emoji */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .slide-purpose {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slide-content-wrapper {
            display: flex;
            justify-content: flex-start; /* Align content to the left */
            width: 100%;
        }

        #chartContainer {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        #lastUpdated, #dataSource {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 1rem;
        }

        a {
            color: #3498db;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        @media (max-width: 600px) {
            .container {
                padding: 1rem;
                width: 95%;
            }

            h1 {
                font-size: 1.5rem;
            }

            #amount {
                font-size: 2rem;
            }

            #amountJapanese {
                font-size: 1rem;
            }

            .slide {
                font-size: 0.8rem;
            }

            .slide-amount {
                min-width: 70px;
            }

            #chartContainer {
                height: 250px;
            }
        }

        #slider-container {
            position: relative;
            margin-top: 1rem;
        }

        #info-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            max-height: 80%;
            overflow-y: auto;
        }

        .popup-content h3 {
            margin-top: 0;
        }

        .popup-content ul {
            list-style-type: none;
            padding: 0;
        }

        .popup-content li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>日本政府によるウクライナ支援金</h1>
        <p id="amount"></p>
        <p id="amountJapanese"></p>
        <div id="slider-container">
            <div id="slider"></div>
            <div id="info-icon">ℹ️</div>
        </div>
        <div id="chartContainer" style="width: 100%; height: 400px;">
            <canvas id="cumulativeChart"></canvas>
        </div>
        <p id="lastUpdated"></p>
        <p id="dataSource">データソース: <a href="https://www.ifw-kiel.de/topics/war-against-ukraine/ukraine-support-tracker/" target="_blank">Ukraine Support Tracker</a></p>
        <div id="popup" class="popup">
            <div class="popup-content">
                <h3>支援リスト</h3>
                <ul id="full-list"></ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const totalAmount = 9.80; // Total bilateral allocations in $ billion
            const data = [
                { date: '2022-02-27', amount: 59300000, purpose: '🤲 緊急道支援' },
                { date: '2022-03-04', amount: null, purpose: '🪖 軍事基本物資の供与（防弾チョッキ、ヘルメット、発電機、食料品）' },
                { date: '2022-03-24', amount: 53870000, purpose: '🤲 緊急人道支援' },
                { date: '2022-03-25', amount: 100000000, purpose: '💰 世界銀行と協力して融資' },
                { date: '2022-04-19', amount: 200000000, purpose: '💰 融資の増額' },
                { date: '2022-04-19', amount: null, purpose: '🪖 防護マスク、化学防護具、ドローン30機の供与' },
                { date: '2022-04-28', amount: 2300000, purpose: '🏥 医療機の供与' },
                { date: '2022-05-19', amount: 300000000, purpose: '💰 融資の増額' },
                { date: '2022-05-27', amount: 1660000, purpose: '💰 緊急支援金' },
                { date: '2022-08-04', amount: null, purpose: '🚐 民間車両（バン）の供与' },
                { date: '2022-08-04', amount: null, purpose: '🪖 小型ドローン12機以上の供与' },
                { date: '2022-11-22', amount: 2570000, purpose: '⚡ 発電機と防寒支援' },
                { date: '2022-12-06', amount: 495370370, purpose: '🤲 人道支援' },
                { date: '2023-01-23', amount: 2570000, purpose: '⚡ 発電機237とソーランタンの供与' },
                { date: '2023-02-14', amount: 550000, purpose: '🧣 防寒支援' },
                { date: '2023-02-21', amount: 5500000000, purpose: '💰 金融支援（信用保証と他の支援を含む）' },
                { date: '2023-02-23', amount: 23000000, purpose: '💰 MIGAのSURE信託基金への拠出' },
                { date: '2023-03-30', amount: 400000000, purpose: '🏗️ 緊急復興支援（フェーズ2）' },
                { date: '2023-03-30', amount: 70000000, purpose: '⚡ 重要エネルギーインフラの復旧支援' },
                { date: '2023-03-30', amount: 30000000, purpose: '🪖 NATOのCAP信託基金への拠出' },
                { date: '2023-04-21', amount: 471000000, purpose: '💰 世界銀行のURTFへの拠出' },
                { date: '2023-06-20', amount: 5000000, purpose: '🌊 洪水災害対応支援' },
                { date: '2023-06-23', amount: null, purpose: '🌊 洪水災害対応資支援' },
                { date: '2023-07-20', amount: 1500000000, purpose: '💰 世界銀行融資のADVANCE信託基金による信用補完' },
                { date: '2023-09-05', amount: 70000000, purpose: '💰 HOPEプロジェクのための世界銀行融資支援' },
                { date: '2023-09-28', amount: null, purpose: '⚡ ネギーインフラ支援（変圧器5台の供与）' },
                { date: '2023-11-07', amount: 230000000, purpose: '💰 ARISEプロジェクトのための世界銀行融資援' },
                { date: '2023-12-04', amount: 1200000000, purpose: '💰 INSPIREプロジェクトのための世界銀行融資支援' },
                { date: '2023-12-06', amount: 4500000000, purpose: '💰 金融支援（二国間協定で確認）' },
                { date: '2023-12-07', amount: 1000000000, purpose: '🤲 人道支援と復興' },
                { date: '2023-12-18', amount: 1086000000, purpose: '💰 PEACEプロジェクトのための世界銀行融資支援' },
                { date: '2024-01-07', amount: 37000000, purpose: '🪖 対ドローンシステムのめのNATO CAP信金への拠出' },
                { date: '2024-01-19', amount: 470000000, purpose: '💰 世界銀行のPEACE MDTFへの拠出' },
                { date: '2024-02-19', amount: 15800000000, purpose: '🏗️ 緊急復興支援（フェーズ3）', currency: 'JPY' },
                { date: '2024-03-26', amount: 984000000, purpose: '💰 成長基盤事業のための世界銀行融資支援' },
                { date: '2024-05-24', amount: 2000000000, purpose: '💰 世界銀行のADVANCEプグラムへの信用補完' }
            ];

            function formatJapaneseNumber(num) {
                const units = ['', '万', '億', '兆'];
                let result = '';
                let unitIndex = 0;

                while (num > 0 && unitIndex < units.length) {
                    const part = num % 10000;
                    if (part > 0) {
                        result = (part + units[unitIndex] + result).replace(/^1(万|億)/, '$1');
                    }
                    num = Math.floor(num / 10000);
                    unitIndex++;
                }

                return result || '0';
            }

            function formatCompactJapaneseNumber(num) {
                const units = ['', '万', '億', '兆'];
                let unitIndex = 0;
                while (num >= 10000 && unitIndex < units.length - 1) {
                    num /= 10000;
                    unitIndex++;
                }
                return num.toFixed(1).replace(/\.0$/, '') + units[unitIndex];
            }

            function formatJapaneseDate(dateString) {
                const [year, month, day] = dateString.split('-');
                return `${year}年${parseInt(month)}月${parseInt(day)}日`;
            }

            async function getExchangeRate() {
                const storedRate = localStorage.getItem('exchangeRate');
                const storedTimestamp = localStorage.getItem('exchangeRateTimestamp');
                
                if (storedRate && storedTimestamp) {
                    const now = new Date().getTime();
                    const hoursSinceLastUpdate = (now - parseInt(storedTimestamp)) / (1000 * 60 * 60);
                    
                    if (hoursSinceLastUpdate < 24) {
                        return parseFloat(storedRate);
                    }
                }

                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    const data = await response.json();
                    const rate = data.rates.JPY;
                    
                    localStorage.setItem('exchangeRate', rate.toString());
                    localStorage.setItem('exchangeRateTimestamp', new Date().getTime().toString());
                    
                    return rate;
                } catch (error) {
                    console.error('Failed to fetch exchange rate:', error);
                    return storedRate ? parseFloat(storedRate) : 110; // Fallback to stored rate or approximate rate
                }
            }

            function createFullList() {
                const fullList = document.getElementById('full-list');
                data.forEach(entry => {
                    const li = document.createElement('li');
                    const japaneseDate = formatJapaneseDate(entry.date);
                    let amountText = '';
                    if (entry.amount !== null) {
                        const amountJPY = entry.currency === 'JPY' ? entry.amount : Math.round(entry.amount * exchangeRate);
                        amountText = `${formatCompactJapaneseNumber(amountJPY)}円 `;
                    }
                    li.textContent = `${japaneseDate}: ${amountText}${entry.purpose}`;
                    fullList.appendChild(li);
                });
            }

            function setupPopup() {
                const infoIcon = document.getElementById('info-icon');
                const popup = document.getElementById('popup');

                infoIcon.addEventListener('mouseenter', () => {
                    popup.style.display = 'block';
                });

                popup.addEventListener('mouseleave', () => {
                    popup.style.display = 'none';
                });
            }

            async function updateDisplay() {
                const exchangeRate = await getExchangeRate();
                console.log("Exchange rate:", exchangeRate);

                const amountElement = document.getElementById('amount');
                const amountJapaneseElement = document.getElementById('amountJapanese');
                const lastUpdatedElement = document.getElementById('lastUpdated');

                // Calculate total amount in JPY
                const totalAmountJPY = Math.round(totalAmount * exchangeRate * 1000000000);
                
                // Update the displayed amount (now in JPY)
                amountElement.textContent = `${formatJapaneseNumber(totalAmountJPY)}円`;
                amountJapaneseElement.textContent = `(${totalAmount.toFixed(2)} billion USD)`;

                // Update the last updated date
                const lastUpdateDate = new Date('2024-06-30');
                lastUpdatedElement.textContent = `最終更新日: ${formatJapaneseDate(lastUpdateDate.toISOString().split('T')[0])}`;

                // Create slides
                const slider = document.getElementById('slider');
                slider.innerHTML = ''; // Clear existing slides
                const slides = data.map(entry => createSlide(entry, exchangeRate));
                slides.forEach(slide => slider.appendChild(slide));

                // Initialize the slider
                let currentSlide = 0;
                slides[currentSlide].style.opacity = 1;

                // Set up slider animation
                setInterval(() => {
                    currentSlide = (currentSlide + 1) % data.length;
                    for (let i = 0; i < slides.length; i++) {
                        slides[i].style.transform = `translateY(${(i - currentSlide) * 100}%)`;
                        slides[i].style.opacity = i === currentSlide ? 1 : 0;
                    }
                }, 5000);

                // Create full list and set up popup after exchange rate is fetched
                createFullList(exchangeRate);
                setupPopup();

                try {
                    await createCumulativeChart(exchangeRate);
                    console.log("Chart creation completed");
                } catch (error) {
                    console.error("Error creating chart:", error);
                }
            }

            let myChart = null;

            function createCumulativeChart(exchangeRate) {
                if (myChart) {
                    myChart.destroy();
                }
                
                console.log("Starting chart creation, exchange rate:", exchangeRate);
                
                let yearlyData = {
                    '2022': 0,
                    '2023': 0,
                    '2024': 0
                };
                let total = 0;

                data.forEach(entry => {
                    if (entry.amount !== null) {
                        const year = entry.date.split('-')[0];
                        const amountJPY = entry.currency === 'JPY' ? entry.amount : Math.round(entry.amount * exchangeRate);
                        
                        if (yearlyData.hasOwnProperty(year)) {
                            yearlyData[year] += amountJPY;
                        }
                        total += amountJPY;
                    }
                });

                console.log("Yearly data:", yearlyData);
                console.log("Total:", total);

                if (total === 0) {
                    console.error("No data to display in the chart");
                    return;
                }

                // Ensure the total matches the totalAmount variable
                const totalAmountJPY = Math.round(totalAmount * exchangeRate * 1000000000);
                const scaleFactor = totalAmountJPY / total;

                Object.keys(yearlyData).forEach(year => {
                    yearlyData[year] = Math.round(yearlyData[year] * scaleFactor);
                });

                console.log("Yearly data after scaling:", yearlyData);
                console.log("Total amount JPY:", totalAmountJPY);

                const ctx = document.getElementById('cumulativeChart');
                if (!ctx) {
                    console.error("Canvas element not found");
                    return;
                }

                console.log("Canvas element found, creating chart");

                try {
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['2022', '2023', '2024', '合計'],
                            datasets: [{
                                label: '支援金額 (円)',
                                data: [...Object.values(yearlyData), totalAmountJPY],
                                backgroundColor: [
                                    'rgba(75, 192, 192, 0.6)',
                                    'rgba(153, 102, 255, 0.6)',
                                    'rgba(255, 159, 64, 0.6)',
                                    'rgba(255, 99, 132, 0.6)'
                                ],
                                borderColor: [
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)',
                                    'rgba(255, 99, 132, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatJapaneseNumber(value) + '円';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += formatJapaneseNumber(context.parsed.y) + '円';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log("Chart creation finished successfully");
                } catch (error) {
                    console.error("Error creating chart:", error);
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                updateDisplay().catch(error => console.error("Error in updateDisplay:", error));
            });
        });
    </script>
</body>
</html>